{% extends 'employee/layout.html.twig' %}

{% block title %}勤怠打刻{% endblock %}

{% block employee_content %}
<div class="attendance-container">
    <!-- リアルタイム時計 -->
    <div class="clock-section">
        <div class="current-time" id="current-time">00:00:00</div>
        <div class="current-date" id="current-date">2024年11月21日(木)</div>
    </div>

    <!-- フラッシュメッセージ -->
    {% for message in app.flashes('success') %}
        <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert alert-error">{{ message }}</div>
    {% endfor %}

    <!-- 現在のステータス -->
    <div class="status-card">
        <h3 class="status-title">現在のステータス</h3>
        <div class="status-badge" id="status-badge">読み込み中...</div>
        <div class="status-details" id="status-details">
            <!-- JavaScriptで動的に更新 -->
        </div>
    </div>

    <!-- 打刻ボタン -->
    <div class="action-buttons">
        <form method="post" action="{{ path('employee_attendance_clock_in') }}" id="clock-in-form">
            <button type="submit" class="btn-action btn-clock-in" id="btn-clock-in">
                <i class="mdi mdi-login"></i>
                <span>出勤打刻</span>
            </button>
        </form>

        <form method="post" action="{{ path('employee_attendance_break_start') }}" id="break-start-form">
            <button type="submit" class="btn-action btn-break" id="btn-break-start">
                <i class="mdi mdi-coffee"></i>
                <span>休憩開始</span>
            </button>
        </form>

        <form method="post" action="{{ path('employee_attendance_break_end') }}" id="break-end-form">
            <button type="submit" class="btn-action btn-break" id="btn-break-end">
                <i class="mdi mdi-coffee-off"></i>
                <span>休憩終了</span>
            </button>
        </form>

        <form method="post" action="{{ path('employee_attendance_clock_out') }}" id="clock-out-form">
            <button type="submit" class="btn-action btn-clock-out" id="btn-clock-out">
                <i class="mdi mdi-logout"></i>
                <span>退勤打刻</span>
            </button>
        </form>
    </div>

    <!-- 本日のサマリー -->
    <div class="summary-card">
        <h3>本日のサマリー</h3>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-label">出勤</div>
                <div class="summary-value" id="summary-clock-in">--:--</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">退勤</div>
                <div class="summary-value" id="summary-clock-out">--:--</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">休憩</div>
                <div class="summary-value" id="summary-break">0分</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">勤務時間</div>
                <div class="summary-value" id="summary-working">0分</div>
            </div>
        </div>
    </div>

    <!-- 履歴リンク -->
    <div class="history-link">
        <a href="{{ path('employee_attendance_history') }}" class="btn btn-secondary btn-block">
            <i class="mdi mdi-history"></i> 勤務履歴を見る
        </a>
    </div>
</div>

<style>
.attendance-container {
    padding: 1rem;
    max-width: 600px;
    margin: 0 auto;
}

.clock-section {
    text-align: center;
    padding: 2rem 1rem;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
    border-radius: 16px;
    margin-bottom: 1.5rem;
}

.current-time {
    font-size: 3rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-variant-numeric: tabular-nums;
}

.current-date {
    font-size: 1.125rem;
    color: var(--text-muted);
}

.status-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.status-title {
    font-size: 1rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
}

.status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.status-badge.not-started {
    background: rgba(156, 163, 175, 0.2);
    color: #9ca3af;
}

.status-badge.working {
    background: rgba(74, 222, 128, 0.2);
    color: #4ade80;
}

.status-badge.on-break {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
}

.status-badge.finished {
    background: rgba(96, 165, 250, 0.2);
    color: #60a5fa;
}

.status-details {
    color: var(--text-primary);
    font-size: 0.875rem;
}

.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.btn-action {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1.5rem 1rem;
    border-radius: 12px;
    border: 2px solid transparent;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-action i {
    font-size: 2rem;
}

.btn-clock-in {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
}

.btn-clock-in:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
}

.btn-clock-out {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.btn-clock-out:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

.btn-break {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.btn-break:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.btn-action:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.summary-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.summary-card h3 {
    font-size: 1rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
}

.summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.summary-item {
    text-align: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
}

.summary-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.summary-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.history-link {
    margin-top: 2rem;
}

.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.alert-success {
    background: rgba(74, 222, 128, 0.1);
    border: 1px solid rgba(74, 222, 128, 0.3);
    color: #4ade80;
}

.alert-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
}
</style>

<script>
// リアルタイム時計
function updateClock() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const dateStr = now.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
    
    document.getElementById('current-time').textContent = timeStr;
    document.getElementById('current-date').textContent = dateStr;
}

// 勤怠状況取得
function fetchAttendanceStatus() {
    fetch('{{ path('employee_attendance_today') }}')
        .then(response => response.json())
        .then(data => {
            updateStatus(data);
            updateButtons(data.status);
            updateSummary(data);
        });
}

//ステータス更新
function updateStatus(data) {
    const badge = document.getElementById('status-badge');
    const details = document.getElementById('status-details');
    
    badge.className = 'status-badge ' + data.status;
    
    switch(data.status) {
        case 'not_started':
            badge.textContent = '未出勤';
            details.innerHTML = '本日はまだ出勤していません';
            break;
        case 'working':
            badge.textContent = '勤務中';
            const hours = Math.floor(data.workingMinutes / 60);
            const minutes = data.workingMinutes % 60;
            details.innerHTML = `出勤: ${data.clockIn}<br>勤務時間: ${hours}時間${minutes}分`;
            break;
        case 'on_break':
            badge.textContent = '休憩中';
            details.innerHTML = `出勤: ${data.clockIn}<br>現在休憩中です`;
            break;
        case 'finished':
            badge.textContent = '退勤済み';
            const totalHours = Math.floor(data.workingMinutes / 60);
            const totalMinutes = data.workingMinutes % 60;
            details.innerHTML = `出勤: ${data.clockIn} / 退勤: ${data.clockOut}<br>勤務時間: ${totalHours}時間${totalMinutes}分`;
            break;
    }
}

// ボタンの活性/非活性制御
function updateButtons(status) {
    const clockIn = document.getElementById('btn-clock-in');
    const breakStart = document.getElementById('btn-break-start');
    const breakEnd = document.getElementById('btn-break-end');
    const clockOut = document.getElementById('btn-clock-out');
    
    // 全て無効化
    clockIn.disabled = true;
    breakStart.disabled = true;
    breakEnd.disabled = true;
    clockOut.disabled = true;
    
    // ステータスに応じて有効化
    switch(status) {
        case 'not_started':
            clockIn.disabled = false;
            break;
        case 'working':
            breakStart.disabled = false;
            clockOut.disabled = false;
            break;
        case 'on_break':
            breakEnd.disabled = false;
            break;
    }
}

// サマリー更新
function updateSummary(data) {
    document.getElementById('summary-clock-in').textContent = data.clockIn || '--:--';
    document.getElementById('summary-clock-out').textContent = data.clockOut || '--:--';
    document.getElementById('summary-break').textContent = data.breakMinutes + '分';
    
    const hours = Math.floor(data.workingMinutes / 60);
    const minutes = data.workingMinutes % 60;
    document.getElementById('summary-working').textContent = hours + '時間' + minutes + '分';
}

// 初期化
updateClock();
setInterval(updateClock, 1000);

fetchAttendanceStatus();
setInterval(fetchAttendanceStatus, 30000); // 30秒ごとに更新
</script>
{% endblock %}
