{% extends 'admin/layout.html.twig' %}

{% block title %}設定{% endblock %}

{% block admin_content %}
<div class="page-header">
    <h2 class="page-title">設定</h2>
</div>

{% for message in app.flashes('success') %}
    <div class="alert alert-success">{{ message }}</div>
{% endfor %}

<div class="card">
    <div class="settings-tabs">
        <button class="tab-btn {% if activeTab == 'tenant' %}active{% endif %}" onclick="switchTab('tenant')">
            <i class="mdi mdi-store"></i>
            テナント設定
        </button>
        <button class="tab-btn {% if activeTab == 'system' %}active{% endif %}" onclick="switchTab('system')">
            <i class="mdi mdi-cog"></i>
            システム設定
        </button>
        <button class="tab-btn {% if activeTab == 'account' %}active{% endif %}" onclick="switchTab('account')">
            <i class="mdi mdi-account"></i>
            アカウント設定
        </button>
    </div>

    <div class="tab-content">
        {# テナント設定 #}
        <div class="tab-pane {% if activeTab == 'tenant' %}active{% endif %}" id="tenant-tab">
            <form method="post" action="{{ path('admin_settings_tenant') }}" class="settings-form">
                <div class="form-section">
                    <h3 class="form-section-title">店舗情報</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>店舗名</label>
                            <input type="text" name="tenant_name" value="{{ tenant.name }}" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ドメイン</label>
                            <input type="text" value="{{ tenant.domain }}" class="form-control" disabled>
                            <small class="form-help">ドメインは変更できません。</small>
                        </div>
                    </div>

                    {# 営業時間設定 #}
                    <h3 class="form-section-title mt-4">営業時間設定</h3>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>営業曜日</label>
                            <div class="checkbox-group">
                                {% set weekDays = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'] %}
                                {% set currentDays = tenant.businessDays ?? [] %}
                                {% for i in 0..6 %}
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="business_days[]" value="{{ i }}" 
                                            {% if i in currentDays %}checked{% endif %}>
                                        {{ weekDays[i] }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>営業時間帯</label>
                            <div id="business-hours-container">
                                {% set currentHours = tenant.businessHours ?? [{'start': '10:00', 'end': '22:00'}] %}
                                {% for slot in currentHours %}
                                    <div class="time-slot">
                                        <input type="time" name="business_hours[{{ loop.index0 }}][start]" 
                                            value="{{ slot.start }}" class="form-control" required>
                                        <span>〜</span>
                                        <input type="time" name="business_hours[{{ loop.index0 }}][end]" 
                                            value="{{ slot.end }}" class="form-control" required>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTimeSlot(this)">
                                            <i class="mdi mdi-delete"></i>
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addTimeSlot()">
                                <i class="mdi mdi-plus"></i> 時間帯を追加
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="mdi mdi-content-save"></i> 保存
                    </button>
                </div>
            </form>
        </div>

        {# システム設定 #}
        <div class="tab-pane {% if activeTab == 'system' %}active{% endif %}" id="system-tab">
            <form method="post" action="{{ path('admin_settings_system') }}" class="settings-form">
                <div class="form-section">
                    <h3 class="form-section-title">システム設定</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>タイムゾーン</label>
                            <select name="timezone" class="form-control">
                                <option value="Asia/Tokyo" selected>Asia/Tokyo (日本標準時)</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>言語</label>
                            <select name="language" class="form-control">
                                <option value="ja" selected>日本語</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="mdi mdi-content-save"></i> 保存
                    </button>
                </div>
            </form>
        </div>

        {# アカウント設定 #}
        <div class="tab-pane {% if activeTab == 'account' %}active{% endif %}" id="account-tab">
            <form method="post" action="{{ path('admin_settings_account') }}" class="settings-form">
                <div class="form-section">
                    <h3 class="form-section-title">プロフィール</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>氏名</label>
                            <input type="text" name="name" value="{{ user.name }}" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>メールアドレス</label>
                            <input type="email" value="{{ user.email }}" class="form-control" disabled>
                            <small class="form-help">メールアドレスは変更できません。</small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="form-section-title">パスワード変更</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>新しいパスワード</label>
                            <input type="password" name="new_password" class="form-control" placeholder="変更する場合のみ入力">
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="mdi mdi-content-save"></i> 保存
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function switchTab(tabName) {
    window.location.href = '{{ path('admin_settings_index') }}?tab=' + tabName;
}

let slotIndex = {{ tenant.businessHours|length|default(1) }};

function addTimeSlot() {
    const container = document.getElementById('business-hours-container');
    const div = document.createElement('div');
    div.className = 'time-slot';
    div.innerHTML = `
        <input type="time" name="business_hours[${slotIndex}][start]" class="form-control" required>
        <span>〜</span>
        <input type="time" name="business_hours[${slotIndex}][end]" class="form-control" required>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTimeSlot(this)">
            <i class="mdi mdi-delete"></i>
        </button>
    `;
    container.appendChild(div);
    slotIndex++;
}

function removeTimeSlot(btn) {
    const container = document.getElementById('business-hours-container');
    if (container.children.length > 1) {
        btn.closest('.time-slot').remove();
    } else {
        alert('最低1つの営業時 間帯が必要です。');
    }
}
</script>

<style>
.settings-tabs {
    display: flex;
    border-bottom: 2px solid var(--border-color);
}

.tab-btn {
    flex: 1;
    padding: 1rem;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s;
    border-bottom: 3px solid transparent;
}

.tab-btn:hover {
    color: var(--text-color);
    background: rgba(255, 255, 255, 0.03);
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.tab-content {
    padding: 2rem;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}

.settings-form .form-section {
    margin-bottom: 2rem;
}

.form-section-title {
    font-size: 1.25rem;
    margin-bottom: 1rem;
    color: var(--text-color);
}

.mt-4 {
    margin-top: 2rem;
}

.checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.time-slot {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.time-slot input[type="time"] {
    width: 150px;
}

.time-slot span {
    color: var(--text-muted);
}

.full-width {
    width: 100% !important;
    max-width: 100% !important;
}
</style>
{% endblock %}
