{% extends 'admin/layout.html.twig' %}

{% block title %}設定{% endblock %}

{% block admin_content %}
<div class="page-header">
    <h2 class="page-title">設定</h2>
</div>

{% for message in app.flashes('success') %}
    <div class="alert alert-success">{{ message }}</div>
{% endfor %}

<div class="settings-container">
    <!-- 左側：タブナビゲーション -->
    <div class="settings-sidebar">
        <div class="nav flex-column nav-pills" role="tablist" aria-orientation="vertical">
            <button class="nav-link {% if activeTab == 'tenant' or activeTab is empty %}active{% endif %}" 
                    onclick="switchTab('tenant')" role="tab" aria-selected="true">
                <i class="mdi mdi-store me-2"></i> 店舗設定
            </button>
            <button class="nav-link {% if activeTab == 'account' %}active{% endif %}" 
                    onclick="switchTab('account')" role="tab" aria-selected="false">
                <i class="mdi mdi-account me-2"></i> アカウント設定
            </button>
            <button class="nav-link {% if activeTab == 'system' %}active{% endif %}" 
                    onclick="switchTab('system')" role="tab" aria-selected="false">
                <i class="mdi mdi-cog me-2"></i> システム設定
            </button>
        </div>
    </div>

    <!-- 右側：コンテンツエリア -->
    <div class="settings-content">
        {# 店舗設定 #}
        <div class="tab-pane {% if activeTab == 'tenant' or activeTab is empty %}active{% endif %}" id="tenant-tab">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">店舗設定</h3>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ path('admin_settings_tenant') }}">
                        <div class="form-section">
                            <h4 class="section-title">基本情報</h4>
                            <div class="mb-3">
                                <label class="form-label">店舗名</label>
                                <input type="text" name="tenant_name" value="{{ tenant.name }}" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ドメイン</label>
                                <input type="text" value="{{ tenant.domain }}" class="form-control" disabled>
                                <small class="text-muted">ドメインは変更できません。</small>
                            </div>
                        </div>

                        <div class="form-section mt-4">
                            <h4 class="section-title">カレンダー設定</h4>
                            <div class="mb-3">
                                <label class="form-label">開始曜日</label>
                                <div class="d-flex gap-4">
                                    <label class="radio-label">
                                        <input type="radio" name="calendar_start_day" value="1" {% if tenant.calendarStartDay == 1 %}checked{% endif %}>
                                        月曜始まり
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="calendar_start_day" value="0" {% if tenant.calendarStartDay == 0 %}checked{% endif %}>
                                        日曜始まり
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-section mt-4">
                            <h4 class="section-title">営業時間設定</h4>
                            <div class="mb-3">
                                <label class="form-label">営業曜日</label>
                                <div class="d-flex flex-wrap gap-3">
                                    {% set weekDays = ['日', '月', '火', '水', '木', '金', '土'] %}
                                    {% set currentDays = tenant.businessDays ?? [] %}
                                    {% for i in 0..6 %}
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="business_days[]" value="{{ i }}" 
                                                {% if i in currentDays %}checked{% endif %}>
                                            {{ weekDays[i] }}
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">営業時間帯</label>
                                <div id="business-hours-container">
                                    {% set currentHours = tenant.businessHours ?? [{'start': '10:00', 'end': '22:00'}] %}
                                    {% for slot in currentHours %}
                                        <div class="time-slot mb-2">
                                            <input type="time" name="business_hours[{{ loop.index0 }}][start]" 
                                                value="{{ slot.start }}" class="form-control" required>
                                            <span class="mx-2">～</span>
                                            <input type="time" name="business_hours[{{ loop.index0 }}][end]" 
                                                value="{{ slot.end }}" class="form-control" required>
                                            <button type="button" class="btn btn-outline-danger btn-sm ms-2" onclick="removeTimeSlot(this)">
                                                <i class="mdi mdi-delete"></i>
                                            </button>
                                        </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addTimeSlot()">
                                    <i class="mdi mdi-plus"></i> 時間帯を追加
                                </button>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="mdi mdi-content-save"></i> 保存
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {# アカウント設定 #}
        <div class="tab-pane {% if activeTab == 'account' %}active{% endif %}" id="account-tab">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">アカウント設定</h3>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ path('admin_settings_account') }}">
                        <div class="mb-3">
                            <label class="form-label">氏名</label>
                            <input type="text" name="name" value="{{ user.name }}" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">メールアドレス</label>
                            <input type="email" value="{{ user.email }}" class="form-control" disabled>
                            <small class="text-muted">メールアドレスは変更できません。</small>
                        </div>
                        
                        <h4 class="section-title mt-4">パスワード変更</h4>
                        <div class="mb-3">
                            <label class="form-label">新しいパスワード</label>
                            <input type="password" name="new_password" class="form-control" placeholder="変更する場合のみ入力">
                        </div>

                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="mdi mdi-content-save"></i> 保存
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {# システム設定 #}
        <div class="tab-pane {% if activeTab == 'system' %}active{% endif %}" id="system-tab">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">システム設定</h3>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ path('admin_settings_system') }}">
                        <div class="mb-3">
                            <label class="form-label">タイムゾーン</label>
                            <select name="timezone" class="form-control">
                                <option value="Asia/Tokyo" selected>Asia/Tokyo (日本標準時)</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">言語</label>
                            <select name="language" class="form-control">
                                <option value="ja" selected>日本語</option>
                                <option value="en">English</option>
                            </select>
                        </div>

                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="mdi mdi-content-save"></i> 保存
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function switchTab(tabName) {
    window.location.href = '{{ path('admin_settings_index') }}?tab=' + tabName;
}

let slotIndex = {{ tenant.businessHours|length|default(1) }};

function addTimeSlot() {
    const container = document.getElementById('business-hours-container');
    const div = document.createElement('div');
    div.className = 'time-slot mb-2';
    div.innerHTML = `
        <input type="time" name="business_hours[${slotIndex}][start]" class="form-control" required>
        <span class="mx-2">～</span>
        <input type="time" name="business_hours[${slotIndex}][end]" class="form-control" required>
        <button type="button" class="btn btn-outline-danger btn-sm ms-2" onclick="removeTimeSlot(this)">
            <i class="mdi mdi-delete"></i>
        </button>
    `;
    container.appendChild(div);
    slotIndex++;
}

function removeTimeSlot(btn) {
    const container = document.getElementById('business-hours-container');
    if (container.children.length > 1) {
        btn.closest('.time-slot').remove();
    } else {
        alert('最低1つの営業時 間帯が必要です。');
    }
}
</script>

<style>
.settings-container {
    display: flex;
    gap: 2rem;
    align-items: flex-start;
}

.settings-sidebar {
    width: 250px;
    flex-shrink: 0;
}

.settings-content {
    flex-grow: 1;
    min-width: 0;
}

.nav-pills .nav-link {
    display: block;
    width: 100%;
    text-align: left;
    padding: 1rem 1.5rem;
    color: var(--text-muted);
    background: transparent;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    transition: all 0.2s;
    font-weight: 500;
    border: 1px solid transparent;
}

.nav-pills .nav-link:hover {
    background-color: rgba(255, 255, 255, 0.05);
    color: var(--text-color);
}

.nav-pills .nav-link.active {
    background-color: rgba(124, 77, 255, 0.1);
    color: var(--primary-color);
    font-weight: 600;
    border: 1px solid var(--primary-color);
}

.card {
    background: var(--card-bg);
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid var(--border-color);
}

.card-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: transparent;
}

.card-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
}

.card-body {
    padding: 2rem;
}

.section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

.time-slot {
    display: flex;
    align-items: center;
}

.time-slot input[type="time"] {
    width: 140px;
}

.checkbox-label, .radio-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: var(--text-color);
}

.checkbox-label input, .radio-label input {
    width: 1.1em;
    height: 1.1em;
    cursor: pointer;
    accent-color: var(--primary-color);
}

.form-label {
    color: var(--text-color);
    margin-bottom: 0.5rem;
    display: block;
}

.text-muted {
    color: var(--text-muted) !important;
}
</style>
{% endblock %}
