{% extends 'admin/layout.html.twig' %}

{% block title %}スケジュール管理{% endblock %}

{% block admin_content %}
<div class="page-header">
    <h2 class="page-title">スケジュール管理</h2>
    <div>
        <a href="{{ path('admin_schedule_requests') }}" class="btn btn-secondary">
            <i class="mdi mdi-format-list-bulleted"></i> 希望一覧
        </a>
    </div>
</div>

{% for message in app.flashes('success') %}
    <div class="alert alert-success">{{ message }}</div>
{% endfor %}

<div class="card">
    <div class="calendar-container">
        <div id="calendar"></div>
    </div>
</div>

<!-- イベント詳細モーダル -->
<div id="event-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">イベント詳細</h3>
            <button class="modal-close" onclick="closeModal()">
                <i class="mdi mdi-close"></i>
            </button>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- イベント詳細がここに表示されます -->
        </div>
    </div>
</div>

<style>
.calendar-container {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
}

#calendar {
    background: white;
    padding: 1rem;
    border-radius: 8px;
}

/* FullCalendar Dark Mode Override */
.fc {
    color: #1f2937;
}

.fc-day {
    background: white;
}

.fc-day-today {
    background: #f3f4f6 !important;
}

.fc-col-header-cell {
    background: #f9fafb;
    border-color: #e5e7eb;
}

.fc-scrollgrid {
    border-color: #e5e7eb;
}

.fc-daygrid-day-number {
    color: #374151;
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-primary);
    cursor: pointer;
    font-size: 1.5rem;
    padding: 0;
}

.modal-body {
    padding: 1.5rem;
}

.event-info {
    margin-bottom: 1rem;
}

.event-info-label {
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.event-info-value {
    font-size: 1.125rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
            today: '今日',
            month: '月',
            week: '週',
            day: '日'
        },
        events: '{{ path('admin_schedule_events') }}',
        eventClick: function(info) {
            showEventDetails(info.event);
        },
        height: 'auto',
        contentHeight: 600
    });
    
    calendar.render();
});

function showEventDetails(event) {
    const props = event.extendedProps;
    const modal = document.getElementById('event-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    
    modalTitle.textContent = event.title;
    
    let bodyHTML = `
        <div class="event-info">
            <div class="event-info-label">従業員</div>
            <div class="event-info-value">${props.userName}</div>
        </div>
        <div class="event-info">
            <div class="event-info-label">開始</div>
            <div class="event-info-value">${event.start.toLocaleString('ja-JP')}</div>
        </div>
        <div class="event-info">
            <div class="event-info-label">終了</div>
            <div class="event-info-value">${event.end ? event.end.toLocaleString('ja-JP') : '-'}</div>
        </div>
        <div class="event-info">
            <div class="event-info-label">種別</div>
            <div class="event-info-value">${props.type === 'shift' ? '確定シフト' : 'シフト希望'}</div>
        </div>
    `;
    
    if (props.type === 'request' && props.status === 'submitted') {
        bodyHTML += `
            <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                <form method="post" action="{{ path('admin_schedule_approve', {id: '__ID__'}) }}" style="flex: 1;">
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="mdi mdi-check"></i> 承認
                    </button>
                </form>
                <form method="post" action="{{ path('admin_schedule_reject', {id: '__ID__'}) }}" style="flex: 1;">
                    <button type="submit" class="btn btn-danger btn-block">
                        <i class="mdi mdi-close"></i> 却下
                    </button>
                </form>
            </div>
        `.replace(/__ID__/g, props.requestId);
    }
    
    modalBody.innerHTML = bodyHTML;
    modal.style.display = 'flex';
}

function closeModal() {
    document.getElementById('event-modal').style.display = 'none';
}

// モーダル外クリックで閉じる
document.addEventListener('click', function(event) {
    const modal = document.getElementById('event-modal');
    if (event.target === modal) {
        closeModal();
    }
});
</script>
{% endblock %}
