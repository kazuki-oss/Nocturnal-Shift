{% extends 'admin/layout.html.twig' %}

{% block title %}スケジュール管理{% endblock %}

{% block admin_content %}
<div class="page-header">
    <h2 class="page-title">スケジュール管理</h2>
    <div class="header-actions">
        <a href="{{ path('admin_schedule_requests') }}" class="btn btn-secondary">
            <i class="mdi mdi-format-list-bulleted"></i> 希望一覧
        </a>
    </div>
</div>

{% for message in app.flashes('success') %}
    <div class="alert alert-success">{{ message }}</div>
{% endfor %}

<div class="card">
    <div id="calendar"></div>
</div>

<style>
#calendar {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
}

.fc {
    color: #1f2937;
}

.fc-day {
    background: white;
}

.fc-day-today {
    background: #f3f4f6 !important;
}

.fc-col-header-cell {
    background: #f9fafb;
    border-color: #e5e7eb;
}

.fc .fc-event {
    border-radius: 4px;
    padding: 2px 4px;
    font-size: 0.875rem;
}

/* 土日の背景色 */
.fc-day-sat {
    background-color: #eff6ff; /* 薄い青 */
}
.fc-day-sun {
    background-color: #fef2f2; /* 薄い赤 */
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    
    // 営業時間に基づいてnextDayThresholdを計算
    let nextDayThreshold = '09:00:00'; // デフォルト
    {% if businessHours|length > 0 %}
        // 営業時間の最も遅い終了時刻を取得
        let latestEndTime = null;
        {% for slot in businessHours %}
            const endTime = '{{ slot.end }}';
            if (!latestEndTime || endTime > latestEndTime) {
                latestEndTime = endTime;
            }
        {% endfor %}
        
        if (latestEndTime) {
            // 終了時刻の1時間後をnextDayThresholdに設定
            const [hours, minutes] = latestEndTime.split(':');
            let nextHour = (parseInt(hours) + 1) % 24;
            nextDayThreshold = String(nextHour).padStart(2, '0') + ':' + minutes + ':00';
        }
    {% endif %}

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        firstDay: {{ tenant.calendarStartDay }}, // 設定された開始曜日
        nextDayThreshold: nextDayThreshold, // 営業日ベースの日付判定
        {% if businessHours|length > 0 %}
        // 営業時間に基づいて時間軸を設定（開始6時間前から表示）
        {% set startParts = businessHours[0].start|split(':') %}
        {% set endParts = businessHours|last.end|split(':') %}
        
        {% set startHour = startParts[0]|number_format %}
        {% set endHour = endParts[0]|number_format %}
        
        {% set displayStartHour = (startHour - 6 + 24) % 24 %}
        
        // 終了時間が開始時間より小さい（または同じ）場合は翌日扱いとして24時間を加算
        {% if endHour <= startHour %}
            {% set baseEndHour = endHour + 24 %}
        {% else %}
            {% set baseEndHour = endHour %}
        {% endif %}
        
        // 営業終了時間の6時間後まで表示
        {% set displayEndHour = baseEndHour + 6 %}
        
        slotMinTime: '{{ "%02d"|format(displayStartHour) }}:00:00',
        slotMaxTime: '{{ "%02d"|format(displayEndHour) }}:{{ endParts[1] }}:00',
        {% else %}
        slotMinTime: '12:00:00',
        slotMaxTime: '30:00:00', // 翌朝6時
        {% endif %}
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
            today: '今日',
            month: '月',
            week: '週',
            day: '日'
        },
        // 営業時間設定
        {% if businessHours|length > 0 %}
        businessHours: [
            {% for slot in businessHours %}
            {
                daysOfWeek: {{ businessDays|json_encode|raw }},
                startTime: '{{ slot.start }}',
                endTime: '{{ slot.end }}'
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        {% endif %}
        events: '{{ path('admin_schedule_events') }}',
        displayEventTime: true,
        displayEventEnd: true,
        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            meridiem: false
        },
        slotLabelFormat: {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        },
        eventDidMount: function(info) {
            const props = info.event.extendedProps;
            
            // シフトの場合、ユーザーごとに色を付ける
            if (props.type === 'shift') {
                const userName = props.userName || '';
                const userColor = stringToColor(userName);
                info.el.style.backgroundColor = userColor;
                info.el.style.borderColor = darkenColor(userColor, 20);
                info.el.style.borderLeftWidth = '4px';
                
                // アイコン追加
                const titleEl = info.el.querySelector('.fc-event-title');
                if (titleEl) {
                    const icon = document.createElement('i');
                    icon.className = 'mdi mdi-account-clock';
                    icon.style.marginRight = '4px';
                    titleEl.prepend(icon);
                }
            }
            // イベントの場合
            else if (props.type === 'event') {
                info.el.style.borderLeftWidth = '4px';
                
                const titleEl = info.el.querySelector('.fc-event-title');
                if (titleEl) {
                    const icon = document.createElement('i');
                    icon.className = 'mdi mdi-calendar-star';
                    icon.style.marginRight = '4px';
                    titleEl.prepend(icon);
                }
            }
        },
        eventContent: function(arg) {
            // 時間表示の強制（月表示などでも時間を出すため）
            // ただし、timeGridなどではデフォルトの表示が崩れる可能性があるので、
            // view.typeで判定するか、シンプルな構造にする
            
            const title = arg.event.title;
            const start = arg.event.start;
            const end = arg.event.end;
            
            let timeText = '';
            if (arg.event.allDay) {
                 timeText = '終日';
            } else if (start && end) {
                const startHour = String(start.getHours()).padStart(2, '0');
                const startMin = String(start.getMinutes()).padStart(2, '0');
                const endHour = String(end.getHours()).padStart(2, '0');
                const endMin = String(end.getMinutes()).padStart(2, '0');
                timeText = `${startHour}:${startMin}-${endHour}:${endMin}`;
            } else if (start) {
                 const startHour = String(start.getHours()).padStart(2, '0');
                 const startMin = String(start.getMinutes()).padStart(2, '0');
                 timeText = `${startHour}:${startMin}`;
            }
            
            // HTML構造をFullCalendarの標準に近づける
            return { html: `
                <div class="fc-event-main-frame">
                    <div class="fc-event-time" style="font-size: 0.85em; font-weight: bold;">${timeText}</div>
                    <div class="fc-event-title-container">
                        <div class="fc-event-title fc-sticky">${title}</div>
                    </div>
                </div>
            `};
        },
        height: 'auto'
    });
    
    calendar.render();
    
    // ユーザー名から色を生成
    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const h = hash % 360;
        return `hsl(${h}, 70%, 60%)`;
    }
    
    // 色を暗くする
    function darkenColor(hslColor, percent) {
        const match = hslColor.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
        if (match) {
            const h = match[1];
            const s = match[2];
            const l = Math.max(0, parseInt(match[3]) - percent);
            return `hsl(${h}, ${s}%, ${l}%)`;
        }
        return hslColor;
    }
});
</script>
{% endblock %}
